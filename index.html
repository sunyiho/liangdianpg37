<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç”œç”œåœˆä»·æ ¼é—®é¢˜æ•™å­¦</title>

    <!--
      Standalone-friendly version:
      - All four sections (1~4) are present.
      - All event listeners are attached after DOMContentLoaded.
      - Defensive guards prevent null.addEventListener crashes if an element is missing.
      - Step 4 shows the question (and removes â€œé—®ï¼šâ€ as requested).
      - Fixed runTests() regex so tests pass.
      - UPDATED: display multiplication as â€œ10 Ã— RMâ€¦â€ (commutative form) where requested.
    -->

    <script src="/_sdk/element_sdk.js"></script>
    <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>

    <style>
      body {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }

      * {
        box-sizing: border-box;
      }

      .app-container {
        width: 100%;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 32px;
        margin: 0 0 10px 0;
        font-weight: 700;
      }

      .header p {
        font-size: 16px;
        opacity: 0.9;
        margin: 0;
      }

      .card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        width: 100%;
        margin-bottom: 20px;
      }

      .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        gap: 10px;
      }

      .step {
        flex: 1;
        text-align: center;
        padding: 10px;
        background: #ede9fe; /* æ·¡ç´« */
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s;
        cursor: pointer;
        user-select: none;
        color: #5b21b6; /* ç´«è‰²æ–‡å­— */
      }

      .step.active {
        background: #7c3aed; /* ä¸»ç´«è‰² */
        color: white;
        font-weight: 600;
      }

      .question-box {
        background: #fef3c7;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        border-left: 5px solid #f59e0b;
      }

      .question-box h3 {
        margin: 0 0 10px 0;
        color: #92400e;
        font-size: 18px;
      }

      .question-box p {
        margin: 0;
        color: #78350f;
        font-size: 16px;
        line-height: 1.6;
      }

      .donut-visual {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }

      .donut-item {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s;
        position: relative;
      }

      .donut-item:hover {
        transform: scale(1.1);
      }

      .donut-item::after {
        content: "";
        position: absolute;
        width: 28px;
        height: 28px;
        background: white;
        border-radius: 50%;
      }

      .price-tag {
        text-align: center;
        font-size: 24px;
        font-weight: 700;
        color: #667eea;
        margin: 15px 0;
      }

      .division-visual {
        margin: 20px 0;
      }

      .bar-container {
        background: #e5e7eb;
        height: 40px;
        border-radius: 10px;
        overflow: hidden;
        margin: 15px 0;
        position: relative;
      }

      .bar-segment {
        height: 100%;
        background: #667eea;
        float: left;
        border-right: 2px solid white;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.5s;
      }

      .formula-step {
        background: #f3f4f6;
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
        border-left: 4px solid #667eea;
      }

      .formula-step h4 {
        margin: 0 0 10px 0;
        color: #667eea;
        font-size: 16px;
      }

      .formula {
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
        font-family: "Courier New", monospace;
        text-align: center;
        margin: 10px 0;
      }

      .explanation {
        color: #6b7280;
        font-size: 14px;
        margin-top: 10px;
        line-height: 1.5;
      }

      .quiz-question {
        background: #f9fafb;
        padding: 20px;
        border-radius: 12px;
        margin: 15px 0;
      }

      .quiz-question h4 {
        margin: 0 0 15px 0;
        color: #1f2937;
        font-size: 16px;
      }

      .quiz-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .quiz-option {
        padding: 12px 15px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 15px;
      }

      .quiz-option:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .quiz-option.selected {
        border-color: #667eea;
        background: #e0e7ff;
      }

      .quiz-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
      }

      .quiz-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .feedback {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
        font-size: 14px;
        display: none;
      }

      .feedback.success {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #10b981;
      }

      .feedback.error {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #ef4444;
      }

      .feedback.show {
        display: block;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .btn {
        flex: 1;
        min-width: 120px;
        padding: 14px 24px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #f3f4f6;
        color: #4b5563;
      }

      .btn-secondary:hover {
        background: #e5e7eb;
      }

      .btn-success {
        background: #10b981;
        color: white;
      }

      .btn-success:hover {
        background: #059669;
      }

      .hint-box {
        background: #dbeafe;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        border-left: 4px solid #3b82f6;
        display: none;
      }

      .hint-box.show {
        display: block;
        animation: fadeIn 0.3s;
      }

      .hint-box p {
        margin: 8px 0;
        color: #1e40af;
        font-size: 14px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hidden {
        display: none;
      }

      @media (max-width: 600px) {
        .header h1 {
          font-size: 24px;
        }

        .card {
          padding: 20px;
        }

        .donut-item {
          width: 64px;
          height: 64px;
          font-size: 34px;
        }

        .formula {
          font-size: 18px;
        }

        .btn {
          min-width: 100px;
          padding: 12px 20px;
          font-size: 15px;
        }
      }
    </style>

    <style>
      @view-transition {
        navigation: auto;
      }
    </style>
  </head>

  <body>
    <div class="app-container">
      <div class="header">
        <h1 id="page-title">ğŸ© ç”œç”œåœˆä»·æ ¼é—®é¢˜</h1>
        <p>è·Ÿç€æ­¥éª¤å­¦ä¹ å¦‚ä½•è®¡ç®—ä»·æ ¼</p>
      </div>

      <div class="card">
        <div class="step-indicator">
          <div class="step active" id="step1">1. ç†è§£é—®é¢˜</div>
          <div class="step" id="step2">2. å›¾è§£åˆ†æ</div>
          <div class="step" id="step3">3. ç®—å¼è§£ç­”</div>
          <div class="step" id="step4">4. äº’åŠ¨ç»ƒä¹ </div>
        </div>

        <!-- ç¬¬1æ­¥ï¼šç†è§£é—®é¢˜ -->
        <div id="section1">
          <div class="question-box">
            <h3>ğŸ“ é¢˜ç›®</h3>
            <p id="question-text">6ä¸ªç”œç”œåœˆä»·æ ¼RM3.90ã€‚ä¹°10ä¸ªç”œç”œåœˆéœ€ä»˜å¤šå°‘é’±?</p>
          </div>

          <div class="donut-visual" aria-label="six donuts">
            <div class="donut-item">ğŸ©</div>
            <div class="donut-item">ğŸ©</div>
            <div class="donut-item">ğŸ©</div>
            <div class="donut-item">ğŸ©</div>
            <div class="donut-item">ğŸ©</div>
            <div class="donut-item">ğŸ©</div>
          </div>

          <div class="price-tag">RM 3.90</div>

          <div class="button-group">
            <button class="btn btn-primary" id="start-btn">å¼€å§‹å­¦ä¹  â†’</button>
          </div>
        </div>

        <!-- ç¬¬2æ­¥ï¼šå›¾è§£åˆ†æ -->
        <div id="section2" class="hidden">
          <h3 style="color: #667eea; margin-top: 0">ğŸ’¡ å›¾è§£é—®é¢˜</h3>
          <p style="color: #6b7280; margin-bottom: 20px">è®©æˆ‘ä»¬ç”¨å›¾å½¢æ¥ç†è§£è¿™é“é¢˜</p>

          <div class="division-visual">
            <p style="font-weight: 600; color: #1f2937">æŠŠRM3.90å¹³å‡åˆ†æˆ6ä»½ï¼š</p>
            <div class="bar-container" aria-label="divide 3.90 into 6 parts">
              <div class="bar-segment" style="width: 16.666%">ğŸ©</div>
              <div class="bar-segment" style="width: 16.666%">ğŸ©</div>
              <div class="bar-segment" style="width: 16.666%">ğŸ©</div>
              <div class="bar-segment" style="width: 16.666%">ğŸ©</div>
              <div class="bar-segment" style="width: 16.666%">ğŸ©</div>
              <div class="bar-segment" style="width: 16.666%">ğŸ©</div>
            </div>
            <p style="text-align: center; color: #6b7280; font-size: 14px">æ¯ä¸€ä»½ä»£è¡¨1ä¸ªç”œç”œåœˆçš„ä»·æ ¼</p>
          </div>

          <div class="hint-box" id="hint2">
            <p><strong>ğŸ’¡ æç¤º 1ï¼š</strong>è¦çŸ¥é“10ä¸ªå¤šå°‘é’±ï¼Œæˆ‘ä»¬å…ˆè¦çŸ¥é“1ä¸ªå¤šå°‘é’±</p>
            <p><strong>ğŸ’¡ æç¤º 2ï¼š</strong>æŠŠæ€»ä»·RM3.90é™¤ä»¥6ï¼Œå°±èƒ½ç®—å‡º1ä¸ªçš„ä»·æ ¼</p>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" id="hint2-btn">éœ€è¦æç¤º</button>
            <button class="btn btn-primary" id="next2-btn">ä¸‹ä¸€æ­¥ â†’</button>
          </div>
        </div>

        <!-- ç¬¬3æ­¥ï¼šç®—å¼è§£ç­” -->
        <div id="section3" class="hidden">
          <h3 style="color: #667eea; margin-top: 0">ğŸ“ ç®—å¼è§£ç­”</h3>

          <div class="formula-step">
            <h4>ç¬¬ä¸€æ­¥ï¼šç®—å‡º1ä¸ªç”œç”œåœˆçš„ä»·æ ¼</h4>
            <div class="formula" id="formula-unit">RM3.90 Ã· 6 = RM0.65</div>
            <div class="explanation">ğŸ’¡ æŠŠæ€»ä»·é™¤ä»¥æ•°é‡ï¼Œå¾—å‡ºæ¯ä¸ªç”œç”œåœˆRM0.65</div>
          </div>

          <div class="formula-step" id="step3-2" style="opacity: 0.3">
            <h4>ç¬¬äºŒæ­¥ï¼šç®—å‡º10ä¸ªç”œç”œåœˆçš„ä»·æ ¼</h4>
            <!-- UPDATED: RM0.65 Ã— 10 -> 10 Ã— RM0.65 -->
            <div class="formula" id="formula-total">10 Ã— RM0.65 = RM6.50</div>
            <div class="explanation">ğŸ’¡ ç”¨å•ä»·ä¹˜ä»¥æ•°é‡ï¼Œå¾—å‡º10ä¸ªç”œç”œåœˆRM6.50</div>
          </div>

          <div class="hint-box" id="hint3">
            <p><strong>ğŸ’¡ è®¡ç®—é¡ºåºï¼š</strong></p>
            <p>1. å…ˆé™¤æ³•ï¼šæ‰¾å‡ºå•ä»·ï¼ˆ1ä¸ªå¤šå°‘é’±ï¼‰</p>
            <p>2. å†ä¹˜æ³•ï¼šç®—å‡ºæ€»ä»·ï¼ˆ10ä¸ªå¤šå°‘é’±ï¼‰</p>
          </div>

          <div class="button-group">
            <button class="btn btn-secondary" id="hint3-btn">éœ€è¦æç¤º</button>
            <button class="btn btn-primary" id="reveal-btn">æ˜¾ç¤ºç¬¬äºŒæ­¥</button>
            <button class="btn btn-primary hidden" id="next3-btn">å¼€å§‹ç»ƒä¹  â†’</button>
          </div>
        </div>

        <!-- ç¬¬4æ­¥ï¼šäº’åŠ¨ç»ƒä¹  -->
        <div id="section4" class="hidden">
          <div class="question-box">
            <h3>ğŸ“ é¢˜ç›®</h3>
            <p id="question-text-4">6ä¸ªç”œç”œåœˆä»·æ ¼RM3.90ã€‚ä¹°10ä¸ªç”œç”œåœˆéœ€ä»˜å¤šå°‘é’±?</p>
          </div>

          <h3 style="color: #667eea; margin-top: 0">âœï¸ äº’åŠ¨ç»ƒä¹ </h3>
          <p style="color: #6b7280; margin-bottom: 20px">æµ‹è¯•ä¸€ä¸‹ä½ å­¦ä¼šäº†å—ï¼Ÿ</p>

          <!-- é¢˜ç›®1 -->
          <div class="quiz-question">
            <h4>é¢˜ç›® 1ï¼šè¦ç®—å‡º10ä¸ªç”œç”œåœˆå¤šå°‘é’±ï¼Œåº”è¯¥å…ˆåšå“ªä¸€æ­¥ï¼Ÿ</h4>
            <div class="quiz-options">
              <!-- UPDATED: RM0.65 Ã— 10 -> 10 Ã— RM0.65 -->
              <div class="quiz-option" data-question="q1" data-answer="a">A. 10 Ã— RM0.65</div>
              <div class="quiz-option" data-question="q1" data-answer="b">B. RM3.90 Ã· 6</div>
              <!-- UPDATED: RM3.90 Ã— 10 -> 10 Ã— RM3.90 -->
              <div class="quiz-option" data-question="q1" data-answer="c">C. 10 Ã— RM3.90</div>
            </div>
            <div class="feedback" id="feedback1"></div>
          </div>

          <!-- é¢˜ç›®2 -->
          <div class="quiz-question">
            <h4>é¢˜ç›® 2ï¼š1ä¸ªç”œç”œåœˆå¤šå°‘é’±ï¼Ÿï¼ˆå†™ RMï¼‰</h4>
            <input type="text" inputmode="text" class="quiz-input" id="q2-input" placeholder="RM0.00" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <div class="feedback" id="feedback2"></div>
          </div>

          <!-- é¢˜ç›®3 -->
          <div class="quiz-question">
            <h4>é¢˜ç›® 3ï¼š10ä¸ªç”œç”œåœˆå¤šå°‘é’±ï¼Ÿï¼ˆå†™ RMï¼‰</h4>
            <input type="text" inputmode="text" class="quiz-input" id="q3-input" placeholder="RM0.00" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
            <div class="feedback" id="feedback3"></div>
          </div>

          <div class="button-group">
            <button class="btn btn-success" id="submit-btn">æäº¤ç­”æ¡ˆ</button>
            <button class="btn btn-secondary" id="retry-btn">å†è¯•ä¸€æ¬¡</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // =====================
      // Config
      // =====================
      const config = {
        donutsInBox: 6,
        boxPrice: 3.9,
        targetDonuts: 10,
        page_title: "ğŸ© ç”œç”œåœˆä»·æ ¼é—®é¢˜",
        // æŒ‰ä½ çš„æœ€æ–°è¦æ±‚ï¼šé¢˜å¹²ä¸åŒ…å«â€œé—®ï¼šâ€
        question_text: "6ä¸ªç”œç”œåœˆä»·æ ¼RM3.90ã€‚ä¹°10ä¸ªç”œç”œåœˆéœ€ä»˜å¤šå°‘é’±?",
        start_button: "å¼€å§‹å­¦ä¹ ",
        next_button: "ä¸‹ä¸€æ­¥",
        hint_button: "éœ€è¦æç¤º",
        submit_button: "æäº¤ç­”æ¡ˆ",
        retry_button: "å†è¯•ä¸€æ¬¡",
      };

      // Calculate answers
      const unitPrice = (config.boxPrice / config.donutsInBox).toFixed(2);
      const totalPrice = (Number(unitPrice) * config.targetDonuts).toFixed(2);

      let currentStep = 1;
      let quizAnswers = { q1: null, q2: null, q3: null };

      // =====================
      // Tiny â€œtestsâ€ (console)
      // =====================
      function runTests() {
        const tests = [];

        // Test case 1: known expected values
        tests.push({
          name: "unitPrice should be 0.65",
          pass: unitPrice === "0.65",
          actual: unitPrice,
        });
        tests.push({
          name: "totalPrice should be 6.50",
          pass: totalPrice === "6.50",
          actual: totalPrice,
        });

        // Test case 2: formatting always 2 decimals
        tests.push({
          name: "unitPrice has 2 decimals",
          pass: /^\d+\.\d{2}$/.test(unitPrice),
          actual: unitPrice,
        });
        tests.push({
          name: "totalPrice has 2 decimals",
          pass: /^\d+\.\d{2}$/.test(totalPrice),
          actual: totalPrice,
        });

        // Additional tests
        const expectedUnit = config.boxPrice / config.donutsInBox;
        const eps = 1e-9;

        tests.push({
          name: "unitPrice numeric equals boxPrice/donutsInBox (2dp)",
          pass: Math.abs(Number(unitPrice) - Number(expectedUnit.toFixed(2))) < eps,
          actual: { unitPrice, expected: expectedUnit.toFixed(2) },
        });

        tests.push({
          name: "totalPrice numeric equals unitPrice*targetDonuts (2dp)",
          pass: Math.abs(Number(totalPrice) - Number((Number(unitPrice) * config.targetDonuts).toFixed(2))) < eps,
          actual: { totalPrice, expected: (Number(unitPrice) * config.targetDonuts).toFixed(2) },
        });

        // Test case 4: mobile/tablet should show full keyboard (inputmode=text)
        const q2 = document.getElementById("q2-input");
        const q3 = document.getElementById("q3-input");
        tests.push({
          name: "q2-input inputmode is text",
          pass: !q2 || q2.getAttribute("inputmode") === "text",
          actual: q2?.getAttribute("inputmode"),
        });
        tests.push({
          name: "q3-input inputmode is text",
          pass: !q3 || q3.getAttribute("inputmode") === "text",
          actual: q3?.getAttribute("inputmode"),
        });

        // Test case: question text has no "é—®ï¼š"
        tests.push({
          name: 'question_text should not contain "é—®ï¼š"',
          pass: !config.question_text.includes("é—®ï¼š"),
          actual: config.question_text,
        });

        const failed = tests.filter((t) => !t.pass);
        if (failed.length) {
          console.error("[Tests failed]", failed);
          throw new Error("[Tests failed]");
        } else {
          console.log("[Tests passed]", tests.map((t) => t.name));
        }
      }

      // =====================
      // Helpers
      // =====================
      function $(id) {
        return document.getElementById(id);
      }

      function on(el, event, handler) {
        if (!el) return;
        el.addEventListener(event, handler);
      }

      function showSection(stepNum) {
        for (let i = 1; i <= 4; i++) {
          const section = $("section" + i);
          const step = $("step" + i);
          if (section) section.classList.add("hidden");
          if (step) {
            step.classList.remove("active");
            step.classList.remove("completed");
          }
        }
        const activeSection = $("section" + stepNum);
        const activeStep = $("step" + stepNum);
        if (activeSection) activeSection.classList.remove("hidden");
        if (activeStep) activeStep.classList.add("active");
        currentStep = stepNum;
      }

      // =====================
      // Boot
      // =====================
      document.addEventListener("DOMContentLoaded", () => {
        runTests();

        // Fill dynamic text
        const pageTitle = $("page-title");
        const qText1 = $("question-text");
        const qText4 = $("question-text-4");
        if (pageTitle) pageTitle.textContent = config.page_title;
        if (qText1) qText1.textContent = config.question_text;
        if (qText4) qText4.textContent = config.question_text;

        // Update formulas to match config (in case config changes)
        const fUnit = $("formula-unit");
        const fTotal = $("formula-total");
        if (fUnit) fUnit.textContent = `RM${config.boxPrice.toFixed(2)} Ã· ${config.donutsInBox} = RM${unitPrice}`;
        // UPDATED: RM{unitPrice} Ã— 10 -> 10 Ã— RM{unitPrice}
        if (fTotal) fTotal.textContent = `${config.targetDonuts} Ã— RM${unitPrice} = RM${totalPrice}`;

        // Optional SDK init
        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig: config,
            onConfigChange: async (newConfig) => {
              // Apply updated config text
              if (pageTitle) pageTitle.textContent = newConfig.page_title || config.page_title;
              if (qText1) qText1.textContent = newConfig.question_text || config.question_text;
              if (qText4) qText4.textContent = newConfig.question_text || config.question_text;

              const startBtn = $("start-btn");
              if (startBtn) startBtn.textContent = (newConfig.start_button || config.start_button) + " â†’";

              const nextBtns = document.querySelectorAll('[id^="next"]');
              nextBtns.forEach((btn) => {
                if (btn.textContent.includes("â†’")) {
                  btn.textContent = (newConfig.next_button || config.next_button) + " â†’";
                }
              });

              const hintBtns = document.querySelectorAll('[id$="-btn"][id*="hint"]');
              hintBtns.forEach((btn) => (btn.textContent = newConfig.hint_button || config.hint_button));

              const submitBtn = $("submit-btn");
              const retryBtn = $("retry-btn");
              if (submitBtn) submitBtn.textContent = newConfig.submit_button || config.submit_button;
              if (retryBtn) retryBtn.textContent = newConfig.retry_button || config.retry_button;

              // Also refresh formulas (since config might change numbers)
              if (fUnit) fUnit.textContent = `RM${(newConfig.boxPrice ?? config.boxPrice).toFixed(2)} Ã· ${newConfig.donutsInBox ?? config.donutsInBox} = RM${unitPrice}`;
              if (fTotal) fTotal.textContent = `${newConfig.targetDonuts ?? config.targetDonuts} Ã— RM${unitPrice} = RM${totalPrice}`;
            },
            mapToCapabilities: () => ({
              recolorables: [],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined,
            }),
            mapToEditPanelValues: (cfg) =>
              new Map([
                ["page_title", cfg.page_title || config.page_title],
                ["question_text", cfg.question_text || config.question_text],
                ["start_button", cfg.start_button || config.start_button],
                ["next_button", cfg.next_button || config.next_button],
                ["hint_button", cfg.hint_button || config.hint_button],
                ["submit_button", cfg.submit_button || config.submit_button],
                ["retry_button", cfg.retry_button || config.retry_button],
              ]),
          });
        }

        // Step tabs: clickable anytime (revisit/å¤ä¹ )
        for (let i = 1; i <= 4; i++) {
          const stepEl = $("step" + i);
          if (stepEl) {
            stepEl.setAttribute("role", "button");
            stepEl.setAttribute("tabindex", "0");
            on(stepEl, "click", () => showSection(i));
            on(stepEl, "keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                showSection(i);
              }
            });
          }
        }

        // Wire buttons (defensive)
        on($("start-btn"), "click", () => showSection(2));
        on($("hint2-btn"), "click", () => $("hint2")?.classList.add("show"));
        on($("next2-btn"), "click", () => showSection(3));
        on($("hint3-btn"), "click", () => $("hint3")?.classList.add("show"));

        on($("reveal-btn"), "click", () => {
          const s = $("step3-2");
          if (s) s.style.opacity = "1";
          $("reveal-btn")?.classList.add("hidden");
          $("next3-btn")?.classList.remove("hidden");
        });

        on($("next3-btn"), "click", () => showSection(4));

        // MCQ options
        document.querySelectorAll(".quiz-option").forEach((option) => {
          on(option, "click", function () {
            const question = this.dataset.question;
            const answer = this.dataset.answer;

            document.querySelectorAll(`[data-question="${question}"]`).forEach((opt) => opt.classList.remove("selected"));
            this.classList.add("selected");
            quizAnswers[question] = answer;
          });
        });

        // Submit
        on($("submit-btn"), "click", () => {
          let allCorrect = true;

          // Q1
          const feedback1 = $("feedback1");
          if (quizAnswers.q1 === "b") {
            if (feedback1) {
              feedback1.className = "feedback success show";
              feedback1.textContent = "âœ… æ­£ç¡®ï¼è¦å…ˆç”¨RM3.90Ã·6ç®—å‡º1ä¸ªç”œç”œåœˆçš„ä»·æ ¼ã€‚";
            }
          } else {
            if (feedback1) {
              feedback1.className = "feedback error show";
              feedback1.textContent = "âŒ ä¸å¯¹å“¦ã€‚æƒ³ä¸€æƒ³ï¼šè¦çŸ¥é“10ä¸ªå¤šå°‘é’±ï¼Œæ˜¯ä¸æ˜¯è¦å…ˆçŸ¥é“1ä¸ªå¤šå°‘é’±ï¼Ÿ";
            }
            allCorrect = false;
          }

          // Q2
          const q2ValueRaw = $("q2-input")?.value ?? "";
          const q2Value = q2ValueRaw.replace(/\s+/g, "").toUpperCase();
          const feedback2 = $("feedback2");
          if (q2Value === `RM${unitPrice}`.toUpperCase()) {
            if (feedback2) {
              feedback2.className = "feedback success show";
              feedback2.textContent = `âœ… æ­£ç¡®ï¼RM3.90Ã·6 = RM${unitPrice}`;
            }
          } else {
            if (feedback2) {
              feedback2.className = "feedback error show";
              feedback2.textContent = "âŒ ä¸å¯¹å“¦ã€‚ç”¨RM3.90Ã·6æ¥è®¡ç®—ã€‚";
            }
            allCorrect = false;
          }

          // Q3
          const q3ValueRaw = $("q3-input")?.value ?? "";
          const q3Value = q3ValueRaw.replace(/\s+/g, "").toUpperCase();
          const feedback3 = $("feedback3");
          if (q3Value === `RM${totalPrice}`.toUpperCase()) {
            if (feedback3) {
              feedback3.className = "feedback success show";
              // UPDATED: show as 10 Ã— RM...
              feedback3.textContent = `âœ… æ­£ç¡®ï¼${config.targetDonuts} Ã— RM${unitPrice} = RM${totalPrice}`;
            }
          } else {
            if (feedback3) {
              feedback3.className = "feedback error show";
              // UPDATED: show as 10 Ã— RM...
              feedback3.textContent = `âŒ ä¸å¯¹å“¦ã€‚ç”¨${config.targetDonuts}Ã—RM${unitPrice}æ¥è®¡ç®—ã€‚`;
            }
            allCorrect = false;
          }

          if (allCorrect) {
            setTimeout(() => {
              const celebration = document.createElement("div");
              celebration.style.cssText =
                "position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center;z-index:1000;pointer-events:none;";
              celebration.innerHTML =
                '<h2 style="color:#10b981;margin:0 0 10px 0;font-size:32px;">ğŸ‰ å¤ªæ£’äº†ï¼</h2><p style="color:#6b7280;margin:0;font-size:18px;">ä½ å·²ç»å®Œå…¨æŒæ¡äº†ï¼</p>';
              document.body.appendChild(celebration);
              setTimeout(() => celebration.remove(), 3000);
            }, 500);
          }
        });

        // Retry
        on($("retry-btn"), "click", () => {
          quizAnswers = { q1: null, q2: null, q3: null };
          document.querySelectorAll(".quiz-option").forEach((opt) => opt.classList.remove("selected"));
          if ($("q2-input")) $("q2-input").value = "";
          if ($("q3-input")) $("q3-input").value = "";
          document.querySelectorAll(".feedback").forEach((fb) => fb.classList.remove("show"));
        });
      });
    </script>
  </body>
</html>
